(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;a=self;b=a.WebSharper=a.WebSharper||{};c=b.Control=b.Control||{};d=c.Observer=c.Observer||{};e=d.Message=d.Message||{};f=c.HotStream=c.HotStream||{};g=f.HotStream=f.HotStream||{};h=c.Observable=c.Observable||{};i=a.Microsoft=a.Microsoft||{};j=i.FSharp=i.FSharp||{};k=j.Control=j.Control||{};l=k.ObservableModule=k.ObservableModule||{};m=c.Event=c.Event||{};n=m.Event=m.Event||{};o=c.DelegateEvent=c.DelegateEvent||{};p=o.DelegateEvent=o.DelegateEvent||{};q=b&&b.Obj;r=c.FSharpEvent=c.FSharpEvent||{};s=c.FSharpDelegateEvent=c.FSharpDelegateEvent||{};t=k.EventModule=k.EventModule||{};u=c.MailboxProcessor=c.MailboxProcessor||{};v=a.IntelliFactory;w=v&&v.Runtime;x=b&&b.Util;y=b&&b.List;z=b&&b.Seq;A=b&&b.Unchecked;B=b&&b.Arrays;C=b&&b.Concurrency;D=b&&b.TimeoutException;E=b&&b.Operators;F=b&&b.Collections;G=F&&F.LinkedList;e.Completed={$:2};d.New=function(H,I,J){return{OnNext:H,OnError:I,OnCompleted:function(){return J();}};};d.Of=function(H){return{OnNext:H,OnError:function(I){throw I;},OnCompleted:function(){return null;}};};g=f.HotStream=w.Class({Trigger:function(H){this.Latest[0]={$:1,$0:H};this.Event.event.Trigger(H);},Subscribe:function(H){this.Latest[0]!=null?H.OnNext(this.Latest[0].$0):void 0;return this.Event.event.Subscribe(x.observer(function(I){H.OnNext(I);}));}},null,g);g.New$1=function(){return g.New([null],new r.New());};g.New=function(H,I){return new g({Latest:H,Event:I});};h.Sequence=function(H){function I(J){return J.$==1?h.CombineLatest(J.$0,I(J.$1),function(K,L){return new y.T({$:1,$0:K,$1:L});}):h.Return(y.T.Empty);}return I(y.ofSeq(H));};h.Aggregate=function(H,I,J){return{Subscribe:function(K){var L;L=[I];return H.Subscribe(d.New(function(M){h.Protect(function(){return J(L[0],M);},function(N){L[0]=N;K.OnNext(N);},function(N){K.OnError(N);});},function(M){K.OnError(M);},function(){K.OnCompleted();}));}};};h.SelectMany=function(H){return{Subscribe:function(I){var J,K;function L(){J[0]();K.Dispose();}J=[a.ignore];K=H.Subscribe(x.observer(function(M){var N;N=M.Subscribe(x.observer(function(O){I.OnNext(O);}));J[0]=function(){J[0]();N.Dispose();};}));return{Dispose:function(){return L();}};}};};h.Switch=function(H){return{Subscribe:function(I){var J,K;J=[0];K=[null];return H.Subscribe(x.observer(function(L){var M;J[0]++;K[0]!=null?K[0].$0.Dispose():void 0;M=J[0];K[0]={$:1,$0:L.Subscribe(x.observer(function(N){if(M===J[0])I.OnNext(N);}))};}));}};};h.CombineLatest=function(H,I,J){return{Subscribe:function(K){var L,M,N,O;function P(){var R,S,T,U;R=L[0];S=M[0];R!=null&&R.$==1?S!=null&&S.$==1?(T=R.$0,U=S.$0,h.Protect(function(){return J(T,U);},function(V){K.OnNext(V);},function(V){K.OnError(V);})):void 0:void 0;}function Q(){N.Dispose();O.Dispose();}L=[null];M=[null];N=H.Subscribe(d.New(function(R){L[0]={$:1,$0:R};P();},a.ignore,a.ignore));O=I.Subscribe(d.New(function(R){M[0]={$:1,$0:R};P();},a.ignore,a.ignore));return{Dispose:function(){return Q();}};}};};h.Range=function(H,I){return{Subscribe:function(J){var L,M;function K(){}for(L=H,M=H+I;L<=M;L++)J.OnNext(L);return{Dispose:function(){return K();}};}};};h.Concat=function(H,I){return{Subscribe:function(J){var K,L;function M(){K[0]!=null?K[0].$0.Dispose():void 0;L.Dispose();}K=[null];L=H.Subscribe(d.New(function(N){J.OnNext(N);},a.ignore,function(){K[0]={$:1,$0:I.Subscribe(J)};}));return{Dispose:function(){return M();}};}};};h.Merge=function(H,I){return{Subscribe:function(J){var K,L,M,N;function O(){M.Dispose();N.Dispose();}K=[false];L=[false];M=H.Subscribe(d.New(function(P){J.OnNext(P);},a.ignore,function(){K[0]=true;K[0]&&L[0]?J.OnCompleted():void 0;}));N=I.Subscribe(d.New(function(P){J.OnNext(P);},a.ignore,function(){L[0]=true;K[0]&&L[0]?J.OnCompleted():void 0;}));return{Dispose:function(){return O();}};}};};h.Drop=function(H,I){return{Subscribe:function(J){var K;K=[0];return I.Subscribe(d.New(function(L){K[0]++;K[0]>H?J.OnNext(L):void 0;},function(L){J.OnError(L);},function(){J.OnCompleted();}));}};};h.Choose=function(H,I){return{Subscribe:function(J){return I.Subscribe(d.New(function(K){function L(M){J.OnNext(M);}h.Protect(function(){return H(K);},function(M){if(M==null);else L(M.$0);},function(M){J.OnError(M);});},function(K){J.OnError(K);},function(){J.OnCompleted();}));}};};h.Filter=function(H,I){return{Subscribe:function(J){return I.Subscribe(d.New(function(K){function L(M){J.OnNext(M);}h.Protect(function(){return H(K)?{$:1,$0:K}:null;},function(M){if(M==null);else L(M.$0);},function(M){J.OnError(M);});},function(K){J.OnError(K);},function(){J.OnCompleted();}));}};};h.Map=function(H,I){return{Subscribe:function(J){return I.Subscribe(d.New(function(K){h.Protect(function(){return H(K);},function(L){J.OnNext(L);},function(L){J.OnError(L);});},function(K){J.OnError(K);},function(){J.OnCompleted();}));}};};h.Protect=function(H,I,J){var K;try{K={$:0,$0:H()};}catch(L){K={$:1,$0:L};}return K.$==1?J(K.$0):I(K.$0);};h.Never=function(){return{Subscribe:function(){function H(){}return{Dispose:function(){return H();}};}};};h.Return=function(H){return{Subscribe:function(I){function J(){}I.OnNext(H);I.OnCompleted();return{Dispose:function(){return J();}};}};};h.Of=function(H){return{Subscribe:function(I){var J;J=H(function(K){I.OnNext(K);});return{Dispose:function(){return J();}};}};};l.Split=function(H,I){return[h.Choose(function(J){var K;K=H(J);return K.$==0?{$:1,$0:K.$0}:null;},I),h.Choose(function(J){var K;K=H(J);return K.$==1?{$:1,$0:K.$0}:null;},I)];};l.Scan=function(H,I,J){return{Subscribe:function(K){var L;L=[I];return J.Subscribe(d.New(function(M){h.Protect(function(){return H(L[0],M);},function(N){L[0]=N;K.OnNext(N);},function(N){K.OnError(N);});},function(M){K.OnError(M);},function(){K.OnCompleted();}));}};};l.Partition=function(H,I){function J(K){return!K;}return[h.Filter(H,I),h.Filter(function(K){return J(H(K));},I)];};l.Pairwise=function(H){return{Subscribe:function(I){var J;J=[null];return H.Subscribe(d.New(function(K){var L;L=J[0];L!=null&&L.$==1?I.OnNext([L.$0,K]):void 0;J[0]={$:1,$0:K};},function(K){I.OnError(K);},function(){I.OnCompleted();}));}};};n=m.Event=w.Class({Subscribe$1:function(H){var I;function J(L,M){return H.OnNext(M);}function K(){I.RemoveHandler$1(J);}I=this;this.AddHandler$1(J);return{Dispose:function(){return K();}};},RemoveHandler$1:function(H){var I,J;I=z.tryFindIndex(function(K){return A.Equals(H,K);},this.Handlers);I==null?void 0:(J=this.Handlers,J.splice.apply(J,[I.$0,1]));},AddHandler$1:function(H){this.Handlers.push(H);},Trigger:function(H){var I,J,K;I=this.Handlers.slice();for(J=0,K=I.length-1;J<=K;J++)(B.get(I,J))(null,H);},RemoveHandler:function(H){this.RemoveHandler$1(H);},AddHandler:function(H){this.AddHandler$1(H);},Subscribe:function(H){return this.Subscribe$1(H);},Dispose:a.ignore},null,n);n.New=function(H){return new n({Handlers:H});};p=o.DelegateEvent=w.Class({RemoveHandler$1:function(H){var I,J;I=z.tryFindIndex(function(K){return A.Equals(H,K);},this.Handlers);I==null?void 0:(J=this.Handlers,J.splice.apply(J,[I.$0,1]));},AddHandler$1:function(H){this.Handlers.push(H);},Trigger:function(H){var I,J,K;I=this.Handlers.slice();for(J=0,K=I.length-1;J<=K;J++)B.get(I,J).apply(null,H);},RemoveHandler:function(H){this.RemoveHandler$1(H);},AddHandler:function(H){this.AddHandler$1(H);},Dispose:a.ignore},null,p);p.New=function(H){return new p({Handlers:H});};r=c.FSharpEvent=w.Class({},q,r);r.New=w.Ctor(function(){q.New.call(this);this.event=n.New([]);},r);s=c.FSharpDelegateEvent=w.Class({},q,s);s.New=w.Ctor(function(){q.New.call(this);this.event=p.New([]);},s);t.Split=function(H,I){return[t.Choose(function(J){var K;K=H(J);return K.$==0?{$:1,$0:K.$0}:null;},I),t.Choose(function(J){var K;K=H(J);return K.$==1?{$:1,$0:K.$0}:null;},I)];};t.Scan=function(H,I,J){var K;K=[I];return t.Map(function(L){K[0]=H(K[0],L);return K[0];},J);};t.Partition=function(H,I){function J(K){return!K;}return[t.Filter(H,I),t.Filter(function(K){return J(H(K));},I)];};t.Pairwise=function(H){var I,J;I=[null];J=n.New([]);H.Subscribe(x.observer(function(K){var L;L=I[0];L!=null&&L.$==1?(I[0]={$:1,$0:K},J.Trigger([L.$0,K])):I[0]={$:1,$0:K};}));return J;};t.Merge=function(H,I){var J;J=n.New([]);H.Subscribe(x.observer(function(K){J.Trigger(K);}));I.Subscribe(x.observer(function(K){J.Trigger(K);}));return J;};t.Map=function(H,I){var J;J=n.New([]);I.Subscribe(x.observer(function(K){J.Trigger(H(K));}));return J;};t.Filter=function(H,I){var J;J=n.New([]);I.Subscribe(x.observer(function(K){if(H(K))J.Trigger(K);}));return J;};t.Choose=function(H,I){var J;J=new r.New();I.Subscribe(x.observer(function(K){var L;L=H(K);L==null?void 0:J.event.Trigger(L.$0);}));return J.event;};u=c.MailboxProcessor=w.Class({dequeue:function(){var H;H=this.mailbox.n.v;this.mailbox.RemoveFirst();return H;},resume:function(){var H;H=this.savedCont;H!=null&&H.$==1?(this.savedCont=null,this.startAsync(H.$0)):void 0;},startAsync:function(H){C.Start(H,this.token);},Scan:function(H,I){var J,K;J=this;K=null;return C.Delay(function(){return C.Bind(J.TryScan(H,I),function(L){var M,N;if(L!=null&&L.$==1)N=L.$0;else throw new D.New();return C.Return(N);});});},TryScan:function(H,I){var J,K,L,M;J=this;K=(L=this.get_DefaultTimeout(),I==null?L:I.$0);M=null;return C.Delay(function(){var N,O,P,R;function Q(S){var U,V;function T(){var X;J.savedCont={$:1,$0:(X=null,C.Delay(function(){var Y;Y=H(J.mailbox.n.v);return Y!=null&&Y.$==1?(J.mailbox.RemoveFirst(),C.Bind(Y.$0,function(Z){S({$:1,$0:Z});return C.Zero();})):(T(),C.Zero());}))};}function W(){var X;J.savedCont={$:1,$0:(X=null,C.Delay(function(){var Y;Y=H(J.mailbox.n.v);return Y!=null&&Y.$==1?(J.mailbox.RemoveFirst(),C.Bind(Y.$0,function(Z){return U[0]?(U[0]=false,a.clearTimeout(V),S({$:1,$0:Z}),C.Zero()):C.Zero();})):(W(),C.Zero());}))};}if(K<0){T();}else{U=[true];V=a.setTimeout(function(){if(U[0]){U[0]=false;J.savedCont=null;S(null);}},K);W();}}O=J.mailbox.n;P=null;while(!A.Equals(O,null)){R=H(O.v);R==null?O=O.n:(J.mailbox.Remove$1(O),O=null,P=R);}N=P;return N!=null&&N.$==1?C.Bind(N.$0,function(S){return C.Return({$:1,$0:S});}):C.FromContinuations(function(S,T,U){return Q.apply(null,[S,T,U]);});});},PostAndAsyncReply:function(H,I){var J,K;J=this;K=null;return C.Delay(function(){return C.Bind(J.PostAndTryAsyncReply(H,I),function(L){var M,N;if(L!=null&&L.$==1)N=L.$0;else throw new D.New();return C.Return(N);});});},PostAndTryAsyncReply:function(H,I){var J,K,L;function M(N){var P;function O(Q){return{$:1,$0:Q};}if(K<0){J.mailbox.AddLast(H(function(Q){return N(O(Q));}));J.resume();}else{P=[true];J.mailbox.AddLast(H(function(Q){if(P[0]){P[0]=false;N({$:1,$0:Q});}}));J.resume();a.setTimeout(function(){if(P[0]){P[0]=false;N(null);}},K);}}J=this;K=(L=this.get_DefaultTimeout(),I==null?L:I.$0);return C.FromContinuations(function(N,O,P){return M.apply(null,[N,O,P]);});},get_CurrentQueueLength:function(){return this.mailbox.c;},Receive:function(H){var I,J;I=this;J=null;return C.Delay(function(){return C.Bind(I.TryReceive(H),function(K){var L,M;if(K!=null&&K.$==1)M=K.$0;else throw new D.New();return C.Return(M);});});},TryReceive:function(H){var I,J,K;function L(M){var N,O,P,Q;if(A.Equals(I.mailbox.n,null)){if(J<0){I.savedCont={$:1,$0:(N=null,C.Delay(function(){M({$:1,$0:I.dequeue()});return C.Zero();}))};}else{O=[true];P=a.setTimeout(function(){if(O[0]){O[0]=false;I.savedCont=null;M(null);}},J);I.savedCont={$:1,$0:(Q=null,C.Delay(function(){return O[0]?(O[0]=false,a.clearTimeout(P),M({$:1,$0:I.dequeue()}),C.Zero()):C.Zero();}))};}}else M({$:1,$0:I.dequeue()});}I=this;J=(K=this.get_DefaultTimeout(),H==null?K:H.$0);return C.FromContinuations(function(M,N,O){return L.apply(null,[M,N,O]);});},Start:function(){var H,I;H=this;this.started?E.FailWith("The MailboxProcessor has already been started."):(this.started=true,H.startAsync((I=null,C.Delay(function(){return C.TryWith(C.Delay(function(){return C.Bind(H.initial(H),function(){return C.Return(null);});}),function(J){H.errorEvent.event.Trigger(J);return C.Zero();});}))));},set_DefaultTimeout:function(H){this.DefaultTimeout=H;},get_DefaultTimeout:function(){return this.DefaultTimeout;},remove_Error:function(H){this.errorEvent.event.RemoveHandler(H);},add_Error:function(H){this.errorEvent.event.AddHandler(H);},get_Error:function(){return this.errorEvent.event;}},q,u);u.Start=function(H,I){var J;J=new u.New(H,I);J.Start();return J;};u.New=w.Ctor(function(H,I){var J,K;function L(M){return J.resume();}J=this;q.New.call(this);this.initial=H;this.token=I;this.started=false;this.errorEvent=new r.New();this.mailbox=new G.New();this.savedCont=null;K=this.token;K==null?void 0:C.Register(K.$0,function(){L();});this.DefaultTimeout=-1;},u);}());
